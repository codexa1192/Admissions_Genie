{% extends "base.html" %}

{% block title %}New Admission - Admissions Genie{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-plus-circle"></i> New Admission Assessment</h2>
        <p class="text-muted">Upload discharge documents and provide admission details for margin analysis.</p>
        <hr>
    </div>
</div>

<form method="POST" action="{{ url_for('admission.new_admission') }}" enctype="multipart/form-data" id="admissionForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="row">
        <!-- Left Column: Document Upload -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-file-upload"></i> Upload Documents</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Discharge Summary</label>
                        <input type="file" class="form-control" name="discharge_summary"
                               accept=".pdf,.docx,.doc,.jpg,.jpeg,.png" multiple>
                        <small class="form-text text-muted">PDF, Word, or images. Multiple files allowed.</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Therapy Evaluations</label>
                        <input type="file" class="form-control" name="therapy_evals"
                               accept=".pdf,.docx,.doc,.jpg,.jpeg,.png" multiple>
                        <small class="form-text text-muted">PT, OT, SLP evaluation documents.</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Nursing Notes (Optional)</label>
                        <input type="file" class="form-control" name="nursing_notes"
                               accept=".pdf,.docx,.doc,.jpg,.jpeg,.png" multiple>
                        <small class="form-text text-muted">Additional nursing documentation.</small>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Note:</strong> AI will extract clinical data from uploaded documents.
                        Supported: ICD-10 codes, medications, functional status, therapy needs, special services.
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Admission Details -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-hospital"></i> Admission Details</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="facility_id" class="form-label fw-bold">Facility *</label>
                        <select class="form-select" id="facility_id" name="facility_id" required>
                            <option value="">Select Facility...</option>
                            {% for facility in facilities %}
                            <option value="{{ facility.id }}">{{ facility.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="payer_id" class="form-label fw-bold">Payer *</label>
                        <select class="form-select" id="payer_id" name="payer_id" required>
                            <option value="">Select Payer...</option>
                            {% for payer in payers %}
                            <option value="{{ payer.id }}">{{ payer.get_display_name() }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- PHI-FREE MODE: Case numbers are auto-generated (no patient identifiers needed) -->
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle"></i>
                        <strong>PHI-Free Mode:</strong> This system does not store any patient identifiers.
                        A unique case number will be auto-generated for tracking purposes.
                    </div>

                    <div class="mb-3">
                        <label for="estimated_los" class="form-label fw-bold">
                            Estimated Length of Stay (days) *
                        </label>
                        <input type="range" class="form-range" id="estimated_los"
                               name="estimated_los" min="3" max="100" value="15" step="1">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">3 days</small>
                            <strong id="los_value" class="text-primary">15 days</strong>
                            <small class="text-muted">100 days</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="auth_status" class="form-label fw-bold">Authorization Status *</label>
                        <select class="form-select" id="auth_status" name="auth_status" required>
                            <option value="granted">Granted - Authorization Approved</option>
                            <option value="pending">Pending - Awaiting Approval</option>
                            <option value="unknown" selected>Unknown - Not Yet Requested</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="current_census_pct" class="form-label fw-bold">
                            Current Census Percentage *
                        </label>
                        <input type="number" class="form-control" id="current_census_pct"
                               name="current_census_pct" min="0" max="100" value="85" step="1" required>
                        <small class="form-text text-muted">Current facility occupancy (0-100%).</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                        <i class="fas fa-calculator"></i> Analyze Admission
                    </button>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-lg ms-3">
                        <i class="fas fa-times"></i> Cancel
                    </a>

                    <div class="mt-3 text-muted">
                        <small><i class="fas fa-lock"></i> All data is encrypted and HIPAA-compliant</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-spinner" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status" style="width: 5rem; height: 5rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 h5">Analyzing documents and calculating margins...</p>
            <small class="text-muted">This may take 15-30 seconds</small>
        </div>
    </div>
</form>

{% endblock %}

{% block extra_scripts %}
<script>
// LOS slider value display
document.getElementById('estimated_los').addEventListener('input', function(e) {
    document.getElementById('los_value').textContent = e.target.value + ' days';
});

// Form submission with loading state
document.getElementById('admissionForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');

    // Show loading overlay
    loadingOverlay.classList.add('active');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
});

// File input validation
const fileInputs = document.querySelectorAll('input[type="file"]');
fileInputs.forEach(input => {
    input.addEventListener('change', function(e) {
        const files = e.target.files;
        const maxSize = 50 * 1024 * 1024; // 50MB

        for (let file of files) {
            if (file.size > maxSize) {
                alert(`File "${file.name}" exceeds 50MB limit. Please choose a smaller file.`);
                e.target.value = '';
                return;
            }
        }
    });
});
</script>

<style>
.loading-spinner {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    color: white;
}

.loading-spinner.active {
    display: flex;
}
</style>
{% endblock %}
