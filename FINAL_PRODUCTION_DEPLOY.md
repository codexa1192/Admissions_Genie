# Final Production Deployment Guide

**Status:** All code is ready. Azure infrastructure is configured. Just need Render to deploy the latest build.

---

## Current Status

✅ **Code:** All production code committed and pushed to GitHub
✅ **Azure PostgreSQL:** Database created and configured
✅ **Azure Blob Storage:** Container created and ready
✅ **Environment Variables:** All 8+ variables configured in Render
⏳ **Render Deployment:** Waiting for build to complete with dependencies

---

## Step 1: Verify Render is Building Latest Code

1. Go to: https://dashboard.render.com
2. Click your **Admissions Genie** web service
3. Check the **status at the top**:
   - If **"Building"** or **"Deploying"** → Wait for it to complete (3-8 more minutes)
   - If **"Live"** → Check the Events tab for deployment timestamp
   - If **"Deploy failed"** → Check Logs tab for errors

---

## Step 2: If Still Showing Old Build

If the health endpoint still shows `psycopg2 not installed` after 10 minutes:

### Force Fresh Deployment:

1. **Trigger Manual Deploy from GitHub:**
   - Click **"Manual Deploy"** (top right)
   - Select **"Deploy latest commit"**
   - Branch: `main`
   - Click **"Deploy"**

2. **OR Clear Cache Again (if above doesn't work):**
   - Click **"Manual Deploy"**
   - Select **"Clear build cache & deploy"**
   - Wait 8-10 minutes

---

## Step 3: Once Deployment Shows "Live"

Test the health endpoint to verify everything is configured:

```bash
curl https://admissions-genie.onrender.com/health/detailed
```

**Expected Output:**
```json
{
  "status": "healthy",
  "checks": {
    "database": {
      "status": "healthy",
      "type": "postgresql"  ← Must show PostgreSQL
    },
    "azure_blob": {
      "status": "configured",
      "account": "admissionsgenie80834"  ← Must show Azure storage
    },
    "azure_openai": {
      "status": "configured",
      "deployment": "gpt-4-turbo"
    }
  }
}
```

**If you see this, you're production ready!** ✅

---

## Step 4: Initialize Production Database

Once health check passes, you need to seed the database with initial data.

### Option A: Via Render Shell (Recommended)

1. Go to Render → Your web service → **Shell** tab
2. Run these commands:

```bash
# Initialize database schema
python3 << 'EOF'
from config.database import init_db
print("Initializing database...")
init_db()
print("✅ Database initialized!")
EOF

# Seed with demo data (facilities, payers, rates, users)
python3 seed_database.py

echo "✅ Production database ready!"
```

### Option B: Run Locally Then Let It Sync

```bash
# On your local machine
cd Documents/Admissions-Genie
python3 seed_database.py
```

This seeds your Azure PostgreSQL database with:
- ✅ 2 users (admin + regular user)
- ✅ 3 sample facilities
- ✅ 4 payers (Medicare FFS, MA, Medicaid, Family Care)
- ✅ Rate configurations
- ✅ 3 pre-loaded sample admissions

---

## Step 5: Test Production Application

### 5.1 Test Login

1. Go to: https://admissions-genie.onrender.com
2. Log in with: `admin@admissionsgenie.com` / `admin123`
3. Should see dashboard with 3 sample admissions

### 5.2 Test File Upload to Azure

1. Click **"New Admission"**
2. Fill in form:
   - Facility: Green Meadows SNF
   - Payer: Medicare FFS
   - Patient Initials: TST
   - Estimated LOS: 20
3. Upload file: `demo_documents/discharge_summary_hip_fracture.txt`
4. Click **"Analyze Admission"**
5. Wait 30-60 seconds for Azure OpenAI processing
6. Should see admission details with margin score

### 5.3 Verify File in Azure Portal

1. Go to: https://portal.azure.com
2. Navigate to: Storage accounts → `admissionsgenie80834`
3. Click: Containers → `admissions-genie-uploads`
4. Should see uploaded file with timestamp

### 5.4 Test Session Timeout

1. Log in
2. Wait 15 minutes (or change SESSION_TIMEOUT_MINUTES=1 for faster test)
3. Try to navigate
4. Should be logged out with "Session expired" message

---

## Production Environment Variables Checklist

Verify all these are set in Render → Environment tab:

### Database (1 variable)
```
✅ DATABASE_URL=postgresql://admissionsgenie_admin:PASSWORD@admissionsgenie-db-XXXXX.postgres.database.azure.com:5432/admissions_genie?sslmode=require
```

### Azure Blob Storage (4 variables)
```
✅ USE_AZURE=true
✅ AZURE_STORAGE_ACCOUNT_NAME=admissionsgenie80834
✅ AZURE_STORAGE_ACCOUNT_KEY=zAN/HBHKKv1l...
✅ AZURE_STORAGE_CONTAINER_NAME=admissions-genie-uploads
```

### Azure OpenAI (3 variables)
```
✅ AZURE_OPENAI_API_KEY=your-key
✅ AZURE_OPENAI_ENDPOINT=https://eastus.api.cognitive.microsoft.com/
✅ AZURE_OPENAI_DEPLOYMENT=gpt-4-turbo
```

### Security (3 variables)
```
✅ SESSION_TIMEOUT_MINUTES=15
✅ SESSION_COOKIE_SECURE=true
✅ PHI_STRICT_MODE=true
```

### Optional (auto-generated if missing)
```
SECRET_KEY=(auto-generated by Flask if not provided)
```

---

## Troubleshooting

### Issue: Health endpoint still shows "psycopg2 not installed"

**Cause:** Render is using cached build or didn't pull latest code

**Fix:**
1. Check Render → Events tab → Verify latest deployment timestamp is recent
2. If old, click "Manual Deploy" → "Deploy latest commit"
3. If still fails, click "Manual Deploy" → "Clear build cache & deploy"

### Issue: "Failed to upload to Azure Blob Storage"

**Cause:** Wrong Azure credentials or container doesn't exist

**Fix:**
1. Verify container exists in Azure Portal
2. Verify AZURE_STORAGE_ACCOUNT_KEY is correct (regenerate if needed)
3. Check Render logs for specific error message

### Issue: "Failed to connect to PostgreSQL"

**Cause:** DATABASE_URL incorrect or firewall blocking

**Fix:**
1. Verify DATABASE_URL format: `postgresql://user:pass@host:5432/dbname?sslmode=require`
2. Check Azure PostgreSQL firewall allows 0.0.0.0-255.255.255.255
3. Test connection from Render shell:
   ```bash
   python3 -c "import os, psycopg2; psycopg2.connect(os.getenv('DATABASE_URL')); print('✅ Connected')"
   ```

### Issue: Login fails with "Invalid credentials"

**Cause:** Database not seeded with users

**Fix:** Run seed_database.py in Render shell (see Step 4 above)

---

## Production Ready Checklist

Before going live with real patient data:

### Infrastructure ✅
- [ ] Health endpoint returns "healthy"
- [ ] Database type shows "postgresql" (not "sqlite")
- [ ] Azure Blob Storage shows "configured"
- [ ] All environment variables present

### Functionality ✅
- [ ] Login works
- [ ] File upload to Azure succeeds
- [ ] File appears in Azure Portal
- [ ] Admission creation completes
- [ ] Data persists across page refresh
- [ ] Session timeout works (15 minutes)

### Security ✅
- [ ] HTTPS enforced (URL starts with https://)
- [ ] SESSION_COOKIE_SECURE=true
- [ ] PHI_STRICT_MODE=true
- [ ] Admin password changed from default
- [ ] Audit logging working (check database audit_log table)

### Data ✅
- [ ] Database seeded with facilities
- [ ] Database seeded with payers
- [ ] Database seeded with rates
- [ ] Database seeded with cost models
- [ ] Sample admissions visible (optional)

---

## Post-Deployment Tasks

### 1. Change Default Admin Password

```bash
# In Render shell or via web interface
python3 << 'EOF'
from models.user import User
admin = User.get_by_email('admin@admissionsgenie.com')
admin.update_password('YOUR_STRONG_PASSWORD_HERE')
print('✅ Admin password updated')
EOF
```

### 2. Create Real User Accounts

Log in as admin → Navigate to user management → Create accounts for staff

### 3. Load Real Facility Data

Admin panel → Facilities → Add your actual SNF facilities

### 4. Load Real Payer Contracts

Admin panel → Payers → Add your contracted payers

### 5. Configure Real Rates

Admin panel → Rates → Add current PDPM rates for each payer

### 6. Load Real Cost Models

Admin panel → Cost Models → Configure actual cost per acuity band

---

## Monitoring

### Check Application Health

```bash
# Run this daily
curl https://admissions-genie.onrender.com/health/detailed
```

### Check Render Logs

1. Render dashboard → Your service → Logs tab
2. Look for errors or warnings
3. Monitor for slow responses

### Check Azure Costs

1. Azure Portal → Cost Management
2. Monitor:
   - OpenAI API usage (~$50-100/month expected)
   - Blob Storage (~$1-2/month expected)
   - PostgreSQL (~$12/month expected)

---

## Support Resources

- **Render Documentation:** https://render.com/docs
- **Azure PostgreSQL Docs:** https://docs.microsoft.com/azure/postgresql/
- **Azure Blob Storage Docs:** https://docs.microsoft.com/azure/storage/blobs/
- **Project README:** [README.md](README.md)
- **Azure Setup Guide:** [AZURE_SETUP.md](AZURE_SETUP.md)

---

## Monthly Cost Summary

| Service | Cost | Required |
|---------|------|----------|
| Azure OpenAI | $50-100 | ✅ Yes |
| Azure Blob Storage | $1-2 | ✅ Yes |
| Azure PostgreSQL | $12 | ✅ Yes |
| Render Web Hosting | $7 | ✅ Yes |
| **Total** | **$70-121** | - |

### Optional Add-Ons:
- Redis (Upstash): $10/month - Async processing
- Celery Worker: FREE - Background tasks
- Sentry: FREE - Error tracking

---

## Success Criteria

Your application is **production ready** when:

1. ✅ Health endpoint shows "healthy" with PostgreSQL and Azure Blob
2. ✅ You can log in successfully
3. ✅ You can upload a file and it appears in Azure Portal
4. ✅ You can create an admission and see the results
5. ✅ Session timeout works after 15 minutes
6. ✅ All environment variables are set correctly
7. ✅ Database is seeded with users, facilities, payers, and rates

**Once all these are true, you can start using it for real admissions!**

---

## Next Steps After Production Ready

1. **Train Staff:** Show admissions staff how to use the system
2. **Pilot Program:** Start with 5-10 admissions to validate results
3. **Monitor Results:** Compare AI recommendations to actual outcomes
4. **Tune Parameters:** Adjust cost models and rates based on real data
5. **Scale Up:** Once validated, use for all admission decisions

---

## HIPAA Compliance Notes

**Current Status:** Demo/Evaluation Mode

**For Production PHI:**
You'll need (estimated 2-3 weeks additional work):
- Enhanced audit logging throughout application
- File encryption at rest in Azure Blob Storage
- Async processing with Celery/Redis
- Business Associate Agreements (BAAs) with:
  - Azure (Microsoft)
  - Render
- Complete security audit
- Staff training on PHI handling

**Cost for Full HIPAA Compliance:** Additional $25-50/month for enhanced infrastructure

---

## Contact

For deployment assistance:
- Email: jthayer@verisightanalytics.com
- Check Render logs first for error messages
- Have your Azure subscription ID ready
